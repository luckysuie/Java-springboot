pipeline {
    agent any

    environment {
        SONAR_TOKEN = credentials('sonarqube-token')      // make sure this matches the ID of your SonarCloud token in Jenkins Credentials
        SONAR_SCANNER_HOME = tool 'sonarscanner'       // make sure this matches the name in Jenkins Global Tool Configuration
    }

    tools {
        maven 'maven'                                  // make sure this matches the name in Jenkins Global Tool Configuration
    }

    stages {

        stage('Git checkout') {
            steps {
                echo 'Checking out source code from Git repository...'
                git branch: 'main', url: 'https://github.com/luckysuie/Java-springboot.git'
            }
        }

        stage('maven package') {
            steps {
                echo 'Building the application using Maven...'
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('sonarCloud analysis') {
            steps {
                echo 'Running SonarCloud analysis...'
                withSonarQubeEnv('sonar-server') {      // make sure this matches the name in Jenkins Global Tool Configuration
                    sh '''
                        ${SONAR_SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=luckysuie_Java-springboot \
                        -Dsonar.sources=. \
                        -Dsonar.host.url=http://4.206.81.78:9000/ \
                        -Dsonar.login=${SONAR_TOKEN}
                    '''
                }
            }
        }

        stage('publish sonarQube report') {
            steps {
                echo 'Re-running sonarQube analysis to publish report...'
                withSonarQubeEnv('sonar-server') {      // make sure this matches the name in Jenkins Global Tool Configuration
                    sh '''
                        ${SONAR_SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=luckysuie_Java-springboot \
                        -Dsonar.sources=. \
                        -Dsonar.host.url=http://4.206.81.78:9000/ \
                        -Dsonar.login=${SONAR_TOKEN} \
                        -Dsonar.qualitygate.wait=false
                    '''
                }
            }
        }

        stage('Login to Azure') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'azure-sp', usernameVariable: 'AZURE_APP_ID', passwordVariable: 'AZURE_PASSWORD'),
                    string(credentialsId: 'azure-tenant', variable: 'AZURE_TENANT')
                ]) {
                    sh '''
                        az login --service-principal -u $AZURE_APP_ID -p $AZURE_PASSWORD --tenant $AZURE_TENANT
                    '''
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    def imageTag = "${env.BUILD_NUMBER}"
                    def imageName = "luckyregistry.azurecr.io/onepiece-app:v${imageTag}"

                    sh '''
                        az acr login --name luckyregistry11
                        docker build -t ${imageName} .
                        docker push ${imageName}
                    '''
                }
            }
        }

    }
}
